<!DOCTYPE html>
<html>
	<head>
		<title>What?</title>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<meta name="viewport" content="width=device-width">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" integrity="sha384-gfdkjb5BdAXd+lj+gudLWI+BXq4IuLW5IT+brZEZsLFm++aCMlF1V92rMkPaX4PP" crossorigin="anonymous">
		<link rel="stylesheet" type="text/css" href="index.css">
	</head>
	<body>
		<div id="video-loading-spinner">
			<i class="fas fa-spinner fa-spin"></i>
		</div>

		<div id="content">

			<input type="file" id="video-file-selector" accept="video/*">

			<video id="video-player" autoplay loop></video>

			<div id="video-controls">

				<input type="range" id="video-seek-bar" value="0" step="0.00001" class="slider">

				<div id="audio-peaks">

					<svg id="audio-peaks-image" viewBox="0 0 100 10" preserveAspectRatio="none">

						<rect id="video-progress-bar" width="0" height="100%" x="0" y="0"
							  style="stroke-width: 0; fill: rgba(112, 112, 112, 0.7);"></rect>
							  
					</svg>

				</div>

			</div>
		</div>
		
		<script src="src/extract-video-audio.js"></script>
		<script>
			// A thread where we'll parse the raw audio samples to find magnitude peaks.
			const peakThread = new Worker("./src/extract-video-audio-peaks.js");

			peakThread.onmessage = (message)=>
			{
				message = message.data;

				switch (message.header)
				{
					case "audio-peaks":
					{
						render_peaks_into_svg(message.body.audioPeaks);
				
						// Set up the video player and controls.
						{
							const player = document.getElementById("video-player");
							const controls = document.getElementById("video-controls");

							player.setAttribute("src", URL.createObjectURL(message.body.videoFile));
							player.setAttribute("type", message.body.videoFile.type);
							controls.style.opacity = "1";
						}

						document.getElementById("video-loading-spinner").style.display = "none";

						break;
					}
					default: console.warn(`Unknown message header "${message.header}".`); break;
				}
			}

			// Load a video file.
			document.getElementById("video-file-selector").onchange = async function()
			{
				document.getElementById("video-loading-spinner").style.display = "block";

				const videoFile = this.files[0];

				this.setAttribute("disabled", "true");

				get_raw_audio(videoFile).then(rawAudio=>peakThread.postMessage(
				{
					header:"extract-audio-peaks",
					body:
					{
						videoFile,
						audioSamples: rawAudio.channels[0],
					}
				}));
			};

			document.getElementById("video-seek-bar").oninput = function()
			{
				const player = document.getElementById("video-player");
				player.currentTime = (player.duration * (this.value / 100))
			}

			function update_seek_bar_position()
			{
				const player = document.getElementById("video-player");

				if (!player.paused)
				{
					const percentProgress = ((player.currentTime / player.duration) * 100);

					document.getElementById("video-seek-bar").value = percentProgress;
					document.getElementById("video-progress-bar").setAttribute("width", `${percentProgress}`);
				}
				
				requestAnimationFrame(update_seek_bar_position);
			}
			requestAnimationFrame(update_seek_bar_position);

			function render_peaks_into_svg(peaks)
			{
				peaks.forEach((peak, idx)=>
				{
					if (!peak)
					{
						return;
					}
					
					const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");

					rect.setAttribute("width", "1");
					rect.setAttribute("height", "100%");
					rect.setAttribute("x", `${idx}`);
					rect.setAttribute("y", "0");

					rect.style.strokeWidth = "0";
					rect.style.fill = "rgba(127, 255, 255, 0.5)";
					rect.style.shapeRendering = "crispedges";

					document.getElementById("audio-peaks-image").appendChild(rect);
				});
			}
		</script>
	</body>
</html>
