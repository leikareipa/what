<!DOCTYPE html>
<html>
	<head>
		<title>What - Tarpeeksi Hyvae Soft</title>
        <meta http-equiv="content-type"
              content="text/html; charset=UTF-8">
        <meta name="viewport"
              content="width=device-width">
        <link rel="stylesheet"
              href="https://use.fontawesome.com/releases/v5.6.1/css/all.css"
              integrity="sha384-gfdkjb5BdAXd+lj+gudLWI+BXq4IuLW5IT+brZEZsLFm++aCMlF1V92rMkPaX4PP"
              crossorigin="anonymous">
        <link rel="stylesheet"
              type="text/css"
              href="index.css">
	</head>
	<body>
        <div id="app">

            <input id="video-file-selector"
                   v-if="!isVideoLoaded"
                   type="file"
                   accept="video/*">

            <div id="video-player-container"
                 v-cloak
                 v-visible-if="isVideoLoaded">
                <video id="video-player" loop></video>
            </div>

            <div id="controls-container"
                 v-cloak
                 v-visible-if="isVideoLoaded">

                <div id="play-button"
                     v-cloak
                     v-on:click="toggle_video_playback()">

                    <i :class="(isVideoPlaying
                                ? 'fas fa-pause'
                                : 'fas fa-play')"></i>

                </div>

                <div id="seek-bar">

                    <div id="spectrogram-container">

                        <canvas id="spectrogram"
                                width="600"
                                height="100">
                        </canvas>
                                
                    </div>

                </div>

                <div id="playback-rate-indicator"
                     v-cloak
                     v-on:click="increase_playback_rate()">

                    {{playbackRate}}

                </div>

            </div>

        </div>

        <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

        <script>
            Vue.directive("visible-if", (el, binding)=>
            {
                el.style.visibility = (binding.value? "visible" : "hidden");
            });

            const playbackRateValues = [1, 4, 8, 16];

            const ui = new Vue({
                el: "#app",
                data: {
                    isVideoLoaded: false,
                    isVideoPlaying: false,
                    isVideoProcessingFinished: false,

                    playbackRate: playbackRateValues[0],
                },
                methods: {
                    increase_playback_rate: function()
                    {
                        playbackRateValues.push(playbackRateValues.shift());
                        this.playbackRate = playbackRateValues[0];
                        playerElement.playbackRate = ui.playbackRate;
                    },

                    toggle_video_playback: function()
                    {
                        if (this.isVideoPlaying)
                        {
                            playerElement.pause();
                            this.isVideoPlaying = false;
                        }
                        else
                        {
                            playerElement.play();
                            this.isVideoPlaying = true;
                        }
                    }
                }
            });

            const playerElement = document.getElementById("video-player");

            // Set up clicking on the seek bar
            {
                const seekBarElement = document.getElementById("seek-bar");

                seekBarElement.onclick = (event)=>
                {
                    const barRect = event.target.getBoundingClientRect();
                    const barWidth = parseFloat(getComputedStyle(seekBarElement).getPropertyValue("width"));
                    const x = (event.pageX - barRect.left); 
                    const y = (event.pageY - barRect.top);
                    const percentPlayback = (x / barWidth);

                    playerElement.currentTime = (playerElement.duration * percentPlayback);

                    if (!ui.isVideoPlaying)
                    {
                        playerElement.play();
                    }

                    repaint_spectrogram();
                }
            }

            const spectrogramElement = document.getElementById("spectrogram");
            const renderWidth = spectrogramElement.width;
            const renderHeight = spectrogramElement.height;
            const renderContext = spectrogramElement.getContext("2d");
            const canvasImage = renderContext.getImageData(0, 0, renderWidth, renderHeight);
            let percentCompleted = 0;

            function set_spectrogram_value(x, y, value)
            {
                y = (renderHeight - y - 1);

                const idx = ((x + y * renderWidth) * 4);
                canvasImage.data[idx+3] = value;
            }

            function get_spectrogram_value(x, y)
            {
                y = (renderHeight - y - 1);

                const idx = ((x + y * renderWidth) * 4);
                return canvasImage.data[idx+3];
            }

            function repaint_spectrogram()
            {
                percentCompleted = Math.max(percentCompleted, ((playerElement.currentTime / playerElement.duration) || 0));
                
                renderContext.putImageData(canvasImage, 0, 0);
                document.getElementById("spectrogram-container").style.width = `${Math.min(100, percentCompleted * 100)}%`;
            }

            for (let y = 0; y < renderHeight; y++)
            {
                for (let x = 0; x < renderWidth; x++)
                {
                    const idx = ((x + y * renderWidth) * 4);
                    canvasImage.data[idx+0] = 0;
                    canvasImage.data[idx+1] = 0;
                    canvasImage.data[idx+2] = 0;
                    canvasImage.data[idx+3] = 0;
                }
            }

            setInterval(()=>
            {
                repaint_spectrogram();

                /// TODO: Stop this interval after video processing is done.
            }, 1000);

			document.getElementById("video-file-selector").onchange = (event)=>
			{
                if (!event.target.files.length)
                {
                    return;
                }

				const videoFile = event.target.files[0];
                const audioContext = new AudioContext();

                playerElement.src = URL.createObjectURL(videoFile);
                playerElement.playbackRate = ui.playbackRate;
                playerElement.onplay = ()=>
                {
                    ui.isVideoLoaded = true;
                    ui.isVideoPlaying = true;
                }
                playerElement.onpaused = ()=>
                {
                    ui.isVideoPlaying = false;
                }
                playerElement.onended = ()=>
                {
                    ui.isVideoPlaying = false;
                    ui.isVideoProcessingFinished = true;
                    percentCompleted = 1;
                }

                const audioSource = audioContext.createMediaElementSource(playerElement);
                const audioAnalyzer = audioContext.createAnalyser();
                audioSource.connect(audioAnalyzer);
                audioAnalyzer.connect(audioContext.destination);

                playerElement.play();

                // Sample the audio buffer every x milliseconds.
                setInterval(()=>
                {
                    const spectrum = new Uint8Array(audioAnalyzer.frequencyBinCount);
                    audioAnalyzer.getByteFrequencyData(spectrum);

                    percentCompleted = Math.max(percentCompleted, ((playerElement.currentTime / playerElement.duration) || 0));

                    for (let y = 0; y < renderHeight; y++)
                    {
                        const sampleIdx = Math.floor(y * ((audioAnalyzer.frequencyBinCount / 8) / renderHeight));
                        const amplitude = Math.min(255, (spectrum[sampleIdx] * 2));
                        const x = Math.floor(renderWidth * percentCompleted);

                        if (get_spectrogram_value(x, y) < amplitude)
                        {
                            set_spectrogram_value(x, y, amplitude);
                        }
                    }
                }, 0);
            };
        </script>
    </body>
</html>

